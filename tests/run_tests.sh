#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤ RAG —Å–∏—Å—Ç–µ–º—ã

set -e

# –ò–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤ (–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è)
TEST_FILE="test_rag_quality.py"
TEST_DIR="$(cd "$(dirname "$0")" && pwd)"

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ RAG —Å–∏—Å—Ç–µ–º—ã${NC}"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è Python
if ! command -v python &> /dev/null; then
    echo -e "${RED}‚ùå Python –Ω–µ –Ω–∞–π–¥–µ–Ω${NC}"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞
if [ ! -f "$TEST_DIR/$TEST_FILE" ]; then
    echo -e "${RED}‚ùå –§–∞–π–ª $TEST_DIR/$TEST_FILE –Ω–µ –Ω–∞–π–¥–µ–Ω${NC}"
    exit 1
fi

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
KB_NAME="${KB_NAME:-Test KB}"
KB_ID="${KB_ID:-}"

# –ü–∞—Ä—Å–∏–Ω–≥ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
while [[ $# -gt 0 ]]; do
    case $1 in
        --kb-name)
            KB_NAME="$2"
            shift 2
            ;;
        --kb-id)
            KB_ID="$2"
            shift 2
            ;;
        --help)
            echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 [OPTIONS]"
            echo ""
            echo "–û–ø—Ü–∏–∏:"
            echo "  --kb-name NAME    –ò–º—è –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 'Test KB')"
            echo "  --kb-id ID        ID –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ --kb-name)"
            echo "  --help            –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É"
            echo ""
            echo "–ü—Ä–∏–º–µ—Ä—ã:"
            echo "  $0 --kb-name 'My KB'"
            echo "  $0 --kb-id 1"
            echo ""
            echo "–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:"
            echo "  KB_NAME           –ò–º—è –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ --kb-name)"
            echo "  KB_ID             ID –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ --kb-id)"
            exit 0
            ;;
        *)
            echo -e "${RED}‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç: $1${NC}"
            echo "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ --help –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏"
            exit 1
            ;;
    esac
done

# –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã
CMD="python $TEST_DIR/$TEST_FILE"

if [ -n "$KB_ID" ]; then
    CMD="$CMD --kb-id $KB_ID"
    echo -e "${YELLOW}üìö –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π —Å ID: $KB_ID${NC}"
else
    CMD="$CMD --kb-name \"$KB_NAME\""
    echo -e "${YELLOW}üìö –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π: $KB_NAME${NC}"
fi

echo ""
echo -e "${GREEN}‚ñ∂ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤...${NC}"
echo ""

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
eval $CMD

EXIT_CODE=$?

echo ""
if [ $EXIT_CODE -eq 0 ]; then
    echo -e "${GREEN}‚úÖ –¢–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ${NC}"
else
    echo -e "${RED}‚ùå –¢–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—å —Å –æ—à–∏–±–∫–∞–º–∏ (–∫–æ–¥: $EXIT_CODE)${NC}"
fi

exit $EXIT_CODE

