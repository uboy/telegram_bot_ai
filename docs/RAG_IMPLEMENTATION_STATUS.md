# –°—Ç–∞—Ç—É—Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —É–ª—É—á—à–µ–Ω–∏–π RAG

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ

### 1. –¢–µ—Å—Ç-–Ω–∞–±–æ—Ä –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞
- ‚úÖ –°–æ–∑–¥–∞–Ω `tests/rag_eval.yaml` —Å —Ç–µ—Å—Ç-–∫–µ–π—Å–∞–º–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ Sync&Build.md
- ‚úÖ –°–æ–∑–¥–∞–Ω `tests/test_rag_quality.py` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞
- ‚úÖ –¢–µ—Å—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç:
  - Retrieval@k (–Ω–∞–π–¥–µ–Ω –ª–∏ –æ–∂–∏–¥–∞–µ–º—ã–π chunk –≤ top-k)
  - –ù–∞–ª–∏—á–∏–µ –æ–∂–∏–¥–∞–µ–º—ã—Ö –∫–æ–º–∞–Ω–¥ –∏ snippets –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö
  - –ö–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–∞ (—Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –∫–æ–º–∞–Ω–¥—ã –∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∏)

### 2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ code blocks –≤ Markdown
- ‚úÖ –ò–∑–º–µ–Ω–µ–Ω `document_loaders.py` –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è code blocks
- ‚úÖ Code blocks –∏–∑–≤–ª–µ–∫–∞—é—Ç—Å—è –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `CODE:`
- ‚úÖ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ `chunk_kind="code"` –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –¥–ª—è code blocks

**–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
```python
# –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ markdown —Ñ–∞–π–ª–∞ code blocks —Ç–µ–ø–µ—Ä—å —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
chunks = document_loader_manager.load_document("Sync&Build.md", "md")
# –ö–æ–º–∞–Ω–¥—ã –∏–∑ ```...``` –±–ª–æ–∫–æ–≤ —Ç–µ–ø–µ—Ä—å –±—É–¥—É—Ç –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å—Å—è
```

## üîÑ –í –ø—Ä–æ—Ü–µ—Å—Å–µ

### 3. –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ –ø–æ knowledge_base_id
**–°—Ç–∞—Ç—É—Å:** –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

**–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ `rag_system.py`:**
- –ó–∞–º–µ–Ω–∏—Ç—å `self.index: faiss.Index` –Ω–∞ `self.index_by_kb: Dict[int, faiss.Index]`
- –ó–∞–º–µ–Ω–∏—Ç—å `self.chunks: List[KnowledgeChunk]` –Ω–∞ `self.chunks_by_kb: Dict[int, List[KnowledgeChunk]]`
- –û–±–Ω–æ–≤–∏—Ç—å `_load_index()` –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω–¥–µ–∫—Å–æ–≤ –ø–æ KB
- –û–±–Ω–æ–≤–∏—Ç—å `add_chunk()` –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å
- –û–±–Ω–æ–≤–∏—Ç—å `search()` –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ –Ω—É–∂–Ω–æ–º –∏–Ω–¥–µ–∫—Å–µ

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** –°–∏–ª—å–Ω—ã–π —Ä–æ—Å—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏, –æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö –±–∞–∑–∞—Ö –∑–Ω–∞–Ω–∏–π

### 4. Cosine similarity –≤–º–µ—Å—Ç–æ L2
**–°—Ç–∞—Ç—É—Å:** –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

**–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ `rag_system.py`:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `faiss.IndexFlatIP` –≤–º–µ—Å—Ç–æ `IndexFlatL2`
- –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å —ç–º–±–µ–¥–¥–∏–Ω–≥–∏: `faiss.normalize_L2(embeddings)` –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º
- –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å query embedding –ø–µ—Ä–µ–¥ –ø–æ–∏—Å–∫–æ–º

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** –ë–æ–ª–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω—ã–π retrieval –Ω–∞ RU+EN

## ‚è≥ –û–∂–∏–¥–∞–µ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### 5. BM25 –≤–º–µ—Å—Ç–æ –ø—Ä–æ—Å—Ç–æ–≥–æ keyword search
**–°—Ç–∞—Ç—É—Å:** –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

**–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å: `pip install rank-bm25`
- –ó–∞–º–µ–Ω–∏—Ç—å `_simple_search()` –Ω–∞ `_bm25_search()` –≤ `rag_system.py`
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `BM25Okapi` –¥–ª—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
- –¢–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è: –∞–Ω–≥–ª - whitespace+lower, —Ä—É—Å - –±—É–∫–≤—ã/—Ü–∏—Ñ—Ä—ã

### 6. –£–ª—É—á—à–µ–Ω–Ω—ã–π —á–∞–Ω–∫–∏–Ω–≥ (—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π)
**–°—Ç–∞—Ç—É—Å:** –ß–∞—Å—Ç–∏—á–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ code blocks)

**–¢—Ä–µ–±—É–µ—Ç—Å—è:**
- –£–ª—É—á—à–∏—Ç—å —Ä–∞–∑–±–∏–µ–Ω–∏–µ –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ: –∑–∞–≥–æ–ª–æ–≤–∫–∏ ‚Üí –∞–±–∑–∞—Ü—ã ‚Üí —Å–ø–∏—Å–∫–∏ ‚Üí code blocks
- –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ —à–∞–≥–∏ "1. ... 2. ..." –ø–æ–ø–∞–¥–∞—é—Ç –≤ –æ–¥–∏–Ω/—Å–æ—Å–µ–¥–Ω–∏–π chunk
- –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ: `section_path`, `chunk_no`, `total_chunks_in_section`

### 7. –£–ª—É—á—à–µ–Ω–∏–µ reranker –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ
**–°—Ç–∞—Ç—É—Å:** –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

**–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é `RAG_RERANK_MODEL_RU` / `RAG_RERANK_MODEL_MULTI`
- –ê–≤—Ç–æ–ø–æ–¥–±–æ—Ä –º–æ–¥–µ–ª–∏ –ø–æ —è–∑—ã–∫—É –∑–∞–ø—Ä–æ—Å–∞ (`detect_language`)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º—É–ª—å—Ç–∏—è–∑—ã—á–Ω—ã–µ –º–æ–¥–µ–ª–∏ –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ

### 8. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å source_id —Ç–µ–≥–∞–º–∏
**–°—Ç–∞—Ç—É—Å:** –ß–∞—Å—Ç–∏—á–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (–µ—Å—Ç—å –±–∞–∑–æ–≤–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞)

**–¢—Ä–µ–±—É–µ—Ç—Å—è —É–ª—É—á—à–µ–Ω–∏–µ:**
- –û–±–æ—Ä–∞—á–∏–≤–∞—Ç—å –∫–∞–∂–¥—ã–π chunk –≤ `<source_id=kb{kb_id}_chunk{chunk_id}>`
- –î–æ–±–∞–≤–∏—Ç—å title, source_path, section_path –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
- –¢—Ä–µ–±–æ–≤–∞—Ç—å –æ—Ç LLM —Ü–∏—Ç–∏—Ä–æ–≤–∞—Ç—å —Ö–æ—Ç—è –±—ã 1 –∏—Å—Ç–æ—á–Ω–∏–∫

## üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã

### –®–∞–≥ 1: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π

```bash
# 1. –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –±–∞–∑—É –∑–Ω–∞–Ω–∏–π
python -c "from rag_system import rag_system; kb = rag_system.add_knowledge_base('Test KB'); print(f'KB ID: {kb.id}')"

# 2. –ó–∞–≥—Ä—É–∑–∏—Ç—å Sync&Build.md –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π
# (—á–µ—Ä–µ–∑ –±–æ—Ç–∞: –∞–¥–º–∏–Ω-–º–µ–Ω—é ‚Üí –ë–∞–∑—ã –∑–Ω–∞–Ω–∏–π ‚Üí Test KB ‚Üí –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç ‚Üí markdown)

# 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
python tests/test_rag_quality.py --kb-name "Test KB"
```

### –®–∞–≥ 2: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞ –ø–æ KB

–°–º. –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –≤ `docs/RAG_IMPROVEMENTS_PLAN.md`, —Ä–∞–∑–¥–µ–ª "–≠—Ç–∞–ø 1: –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è"

### –®–∞–≥ 3: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è cosine similarity

–°–º. `docs/RAG_IMPROVEMENTS_PLAN.md`, —Ä–∞–∑–¥–µ–ª "1.2 Cosine similarity –≤–º–µ—Å—Ç–æ L2"

### –®–∞–≥ 4: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ BM25

```bash
pip install rank-bm25
```

–ó–∞—Ç–µ–º —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `_bm25_search()` –≤ `rag_system.py`

## üéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã

1. **–í—ã—Å–æ–∫–∏–π:** –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ –ø–æ KB + Cosine similarity (–∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–∞)
2. **–°—Ä–µ–¥–Ω–∏–π:** BM25 –ø–æ–∏—Å–∫ (—É–ª—É—á—à–∏—Ç keyword search)
3. **–ù–∏–∑–∫–∏–π:** –£–ª—É—á—à–µ–Ω–Ω—ã–π —á–∞–Ω–∫–∏–Ω–≥ –∏ reranker (—É–ª—É—á—à–∏—Ç –∫–∞—á–µ—Å—Ç–≤–æ, –Ω–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–º–∏
- –¢–µ—Å—Ç—ã –¥–æ–ª–∂–Ω—ã –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞
- –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–µ–ª–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—à–∞–≥–æ–≤–æ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞

