# –û–±–∑–æ—Ä —Ñ–∞–π–ª–æ–≤ —Å–∏—Å—Ç–µ–º—ã RAG

## üìÅ –§–∞–π–ª—ã, –æ—Ç–≤–µ—á–∞—é—â–∏–µ –∑–∞ –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö

### –û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–≥—Ä—É–∑—á–∏–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- **`shared/document_loaders/`** ‚Äî –º–æ–¥—É–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∑–∞–≥—Ä—É–∑—á–∏–∫–æ–≤:
  - **`base.py`** ‚Äî –±–∞–∑–æ–≤—ã–π –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –∫–ª–∞—Å—Å `DocumentLoader`
  - **`markdown_loader.py`** ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ Markdown —Ñ–∞–π–ª–æ–≤ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—ã (–∑–∞–≥–æ–ª–æ–≤–∫–∏, code blocks)
  - **`word_loader.py`** ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ Word –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (.docx)
  - **`pdf_loader.py`** ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ PDF —Ñ–∞–π–ª–æ–≤
  - **`excel_loader.py`** ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ Excel —Ñ–∞–π–ª–æ–≤ (.xlsx, .xls)
  - **`web_loader.py`** ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ –≤–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü (HTML)
  - **`text_loader.py`** ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ –æ–±—ã—á–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
  - **`image_loader.py`** ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

- **`shared/document_loaders.py`** ‚Äî —Ä–µ—ç–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö –∑–∞–≥—Ä—É–∑—á–∏–∫–æ–≤ –∏ –º–µ–Ω–µ–¥–∂–µ—Ä `document_loader_manager`

### –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–∫–∏
- **`shared/wiki_git_loader.py`** ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ –≤–∏–∫–∏ –∏–∑ Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –∏ ZIP –∞—Ä—Ö–∏–≤–æ–≤
  - `load_wiki_from_git()` ‚Äî –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –∏ –∑–∞–≥—Ä—É–∑–∫–∞
  - `load_wiki_from_zip()` ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ ZIP –∞—Ä—Ö–∏–≤–∞
  - `_restore_wiki_url_from_path()` ‚Äî –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ URL —Å—Ç—Ä–∞–Ω–∏—Ü –≤–∏–∫–∏ –∏–∑ –ø—É—Ç–∏ —Ñ–∞–π–ª–∞

- **`shared/wiki_scraper.py`** ‚Äî —Å–∫—Ä–∞–ø–∏–Ω–≥ –≤–∏–∫–∏ —á–µ—Ä–µ–∑ HTTP (—Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –æ–±—Ö–æ–¥ —Å—Ç—Ä–∞–Ω–∏—Ü)

### –°–µ—Ä–≤–∏—Å –∑–∞–≥—Ä—É–∑–∫–∏ (Backend API)
- **`backend/services/ingestion_service.py`** ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
  - `ingest_document_or_archive()` ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏ –∞—Ä—Ö–∏–≤–æ–≤
  - `ingest_web_page()` ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ –≤–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü
  - `ingest_wiki_crawl()` ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ –≤–∏–∫–∏ —á–µ—Ä–µ–∑ —Å–∫—Ä–∞–ø–∏–Ω–≥
  - `ingest_wiki_git()` ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ –≤–∏–∫–∏ –∏–∑ Git
  - `ingest_wiki_zip()` ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ –≤–∏–∫–∏ –∏–∑ ZIP
  - `ingest_image()` ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

---

## üìÑ –§–∞–π–ª—ã, –æ—Ç–≤–µ—á–∞—é—â–∏–µ –∑–∞ —Ä–∞–∑–±–æ—Ä —Ñ–∞–π–ª–æ–≤

### –ü–∞—Ä—Å–∏–Ω–≥ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞
- **`shared/document_loaders/markdown_loader.py`**
  - –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (H1-H6)
  - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ code blocks
  - –û—á–∏—Å—Ç–∫–∞ Markdown —Ä–∞–∑–º–µ—Ç–∫–∏

- **`shared/document_loaders/web_loader.py`**
  - –ü–∞—Ä—Å–∏–Ω–≥ HTML —á–µ—Ä–µ–∑ BeautifulSoup
  - –£–¥–∞–ª–µ–Ω–∏–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
  - –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (h1, title)

- **`shared/document_loaders/word_loader.py`**
  - –ü–∞—Ä—Å–∏–Ω–≥ .docx —á–µ—Ä–µ–∑ python-docx
  - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –ø–æ —Å—Ç–∏–ª—è–º

- **`shared/document_loaders/pdf_loader.py`**
  - –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∏–∑ PDF —á–µ—Ä–µ–∑ PyPDF2
  - –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–æ

- **`shared/image_processor.py`** ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (OCR, –æ–ø–∏—Å–∞–Ω–∏–µ —á–µ—Ä–µ–∑ AI)

---

## ‚úÇÔ∏è –§–∞–π–ª—ã, –æ—Ç–≤–µ—á–∞—é—â–∏–µ –∑–∞ —Ä–∞–∑–±–∏—Ç–∏–µ –Ω–∞ —á–∞–Ω–∫–∏

### –ß–∞–Ω–∫–∏–Ω–≥
- **`shared/document_loaders/chunking.py`** ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å —á–∞–Ω–∫–∏–Ω–≥–∞:
  - **`split_text_into_chunks()`** ‚Äî —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ä–∞–∑–±–∏–≤–∞—Ç–µ–ª—å –ø–æ —Å–∏–º–≤–æ–ª–∞–º
  - **`split_markdown_section_into_chunks()`** ‚Äî —á–∞–Ω–∫–∏–Ω–≥ —Å–µ–∫—Ü–∏–π Markdown
  - **`split_text_structurally()`** ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π —á–∞–Ω–∫–∏–Ω–≥ (–∫–æ–¥, —Å–ø–∏—Å–∫–∏, –∞–±–∑–∞—Ü—ã)

### –õ–æ–≥–∏–∫–∞ —á–∞–Ω–∫–∏–Ω–≥–∞
- **–°—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π —á–∞–Ω–∫–∏–Ω–≥** (`split_text_structurally`):
  - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç code blocks –∫–∞–∫ –∞—Ç–æ–º–∞—Ä–Ω—ã–µ –µ–¥–∏–Ω–∏—Ü—ã
  - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–ø–∏—Å–∫–∏ (–Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–µ/–º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ) —Ü–µ–ª–∏–∫–æ–º
  - –†–∞–∑–±–∏–≤–∞–µ—Ç –∞–±–∑–∞—Ü—ã –ø–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
  - –£—á–∏—Ç—ã–≤–∞–µ—Ç `RAG_CHUNK_SIZE` –∏ `RAG_CHUNK_OVERLAP` –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞

- **Markdown —á–∞–Ω–∫–∏–Ω–≥** (`split_markdown_section_into_chunks`):
  - –†–∞–∑–±–∏–≤–∞–µ—Ç –ø–æ —Å–µ–∫—Ü–∏—è–º (–∑–∞–≥–æ–ª–æ–≤–∫–∞–º)
  - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç code blocks
  - –î–æ–±–∞–≤–ª—è–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –æ —Å–µ–∫—Ü–∏–∏

---

## üîç –§–∞–π–ª—ã, –æ—Ç–≤–µ—á–∞—é—â–∏–µ –∑–∞ –ø–æ–∏—Å–∫

### RAG —Å–∏—Å—Ç–µ–º–∞
- **`shared/rag_system.py`** ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ RAG:
  - **`RAGSystem`** ‚Äî –∫–ª–∞—Å—Å —Å–∏—Å—Ç–µ–º—ã –ø–æ–∏—Å–∫–∞
  - **`search()`** ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –ø–æ–∏—Å–∫–∞ (dense + keyword + rerank)
  - **`_simple_search()`** ‚Äî —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π keyword –ø–æ–∏—Å–∫
  - **`_get_embedding()`** ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤
  - **`_load_index()`** ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ FAISS –∏–Ω–¥–µ–∫—Å–∞

### –ü–æ–∏—Å–∫ –≤–∫–ª—é—á–∞–µ—Ç:
1. **Dense –ø–æ–∏—Å–∫** (–≤–µ–∫—Ç–æ—Ä–Ω—ã–π):
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç FAISS –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —ç–º–±–µ–¥–¥–∏–Ω–≥–∞–º
   - –ú–æ–¥–µ–ª—å: `sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2`

2. **Keyword –ø–æ–∏—Å–∫** (`_simple_search`):
   - –ü–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º –≤ –∫–æ–Ω—Ç–µ–Ω—Ç–µ
   - –ü–æ–∏—Å–∫ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö (title, section_title) —Å –ø–æ–≤—ã—à–µ–Ω–Ω—ã–º –≤–µ—Å–æ–º
   - –ü–æ–∏—Å–∫ –≤ source_path
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è —Ñ—Ä–∞–∑

3. **Reranking** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Cross-Encoder –¥–ª—è –ø–µ—Ä–µ—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—è
   - –£–ª—É—á—à–∞–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### API –¥–ª—è –ø–æ–∏—Å–∫–∞
- **`backend/api/routes/rag.py`** ‚Äî REST API –¥–ª—è –ø–æ–∏—Å–∫–∞:
  - `POST /api/v1/rag/query` ‚Äî –ø–æ–∏—Å–∫ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π

- **`frontend/bot_handlers.py`** ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ Telegram –±–æ—Ç–µ:
  - `handle_text()` ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

- **`frontend/backend_client.py`** ‚Äî HTTP –∫–ª–∏–µ–Ω—Ç –¥–ª—è –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ backend API

---

## üóÑÔ∏è –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

- **`shared/database.py`** ‚Äî —Å—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:
  - `KnowledgeBase` ‚Äî –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
  - `KnowledgeChunk` ‚Äî —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –∑–Ω–∞–Ω–∏–π (—á–∞–Ω–∫–∏)
  - `KnowledgeImportLog` ‚Äî –∂—É—Ä–Ω–∞–ª –∑–∞–≥—Ä—É–∑–æ–∫

- **`shared/rag_system.py`**:
  - `add_chunk()` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ —á–∞–Ω–∫–∞
  - `add_chunks_batch()` ‚Äî –ø–∞–∫–µ—Ç–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —á–∞–Ω–∫–æ–≤
  - –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –≤ FAISS –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞

---

## üìä –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

```
1. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
   ‚îî‚îÄ> ingestion_service.py
       ‚îî‚îÄ> document_loader_manager (document_loaders.py)
           ‚îî‚îÄ> –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π loader (markdown_loader.py, word_loader.py, etc.)
               ‚îî‚îÄ> chunking.py (—Ä–∞–∑–±–∏–µ–Ω–∏–µ –Ω–∞ —á–∞–Ω–∫–∏)
                   ‚îî‚îÄ> rag_system.add_chunks_batch()
                       ‚îî‚îÄ> database.py (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î)
                       ‚îî‚îÄ> FAISS –∏–Ω–¥–µ–∫—Å (–¥–ª—è –ø–æ–∏—Å–∫–∞)

2. –ü–æ–∏—Å–∫
   ‚îî‚îÄ> bot_handlers.py / rag.py
       ‚îî‚îÄ> rag_system.search()
           ‚îú‚îÄ> Dense –ø–æ–∏—Å–∫ (FAISS)
           ‚îú‚îÄ> Keyword –ø–æ–∏—Å–∫ (_simple_search)
           ‚îî‚îÄ> Reranking (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
```

---

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∞–Ω–∫–∏–Ω–≥–∞ –∏ –ø–æ–∏—Å–∫–∞ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤:
- **`shared/config.py`** (–∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è):
  - `RAG_CHUNK_SIZE` ‚Äî —Ä–∞–∑–º–µ—Ä —á–∞–Ω–∫–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 2000 —Å–∏–º–≤–æ–ª–æ–≤)
  - `RAG_CHUNK_OVERLAP` ‚Äî –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ –º–µ–∂–¥—É —á–∞–Ω–∫–∞–º–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 400)
  - `RAG_TOP_K` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
  - `RAG_MAX_CANDIDATES` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –¥–ª—è reranking
  - `RAG_MODEL_NAME` ‚Äî –º–æ–¥–µ–ª—å –¥–ª—è —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤
  - `RAG_ENABLE` ‚Äî –≤–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ RAG

