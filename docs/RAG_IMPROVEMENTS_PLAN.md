# –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —É–ª—É—á—à–µ–Ω–∏–π RAG —Å–∏—Å—Ç–µ–º—ã

## –°—Ç–∞—Ç—É—Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

- ‚úÖ –¢–µ—Å—Ç-–Ω–∞–±–æ—Ä —Å–æ–∑–¥–∞–Ω (`tests/rag_eval.yaml`, `tests/test_rag_quality.py`)
- üîÑ –í –ø—Ä–æ—Ü–µ—Å—Å–µ: –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ –ø–æ KB
- ‚è≥ –û–∂–∏–¥–∞–µ—Ç: Cosine similarity
- ‚è≥ –û–∂–∏–¥–∞–µ—Ç: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ code blocks
- ‚è≥ –û–∂–∏–¥–∞–µ—Ç: –£–ª—É—á—à–µ–Ω–Ω—ã–π —á–∞–Ω–∫–∏–Ω–≥
- ‚è≥ –û–∂–∏–¥–∞–µ—Ç: BM25 –ø–æ–∏—Å–∫

## –≠—Ç–∞–ø 1: –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

### 1.1 –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ –ø–æ knowledge_base_id

**–§–∞–π–ª:** `rag_system.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –ó–∞–º–µ–Ω–∏—Ç—å `self.index: faiss.Index` –Ω–∞ `self.index_by_kb: Dict[int, faiss.Index]`
- –ó–∞–º–µ–Ω–∏—Ç—å `self.chunks: List[KnowledgeChunk]` –Ω–∞ `self.chunks_by_kb: Dict[int, List[KnowledgeChunk]]`
- –û–±–Ω–æ–≤–∏—Ç—å `_load_index()` –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω–¥–µ–∫—Å–æ–≤ –ø–æ KB
- –û–±–Ω–æ–≤–∏—Ç—å `add_chunk()` –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å
- –û–±–Ω–æ–≤–∏—Ç—å `search()` –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ –Ω—É–∂–Ω–æ–º –∏–Ω–¥–µ–∫—Å–µ

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** –°–∏–ª—å–Ω—ã–π —Ä–æ—Å—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏, –æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö –±–∞–∑–∞—Ö –∑–Ω–∞–Ω–∏–π

### 1.2 Cosine similarity –≤–º–µ—Å—Ç–æ L2

**–§–∞–π–ª:** `rag_system.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `faiss.IndexFlatIP` –≤–º–µ—Å—Ç–æ `IndexFlatL2`
- –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º: `faiss.normalize_L2(embeddings)`
- –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å query embedding –ø–µ—Ä–µ–¥ –ø–æ–∏—Å–∫–æ–º

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** –ë–æ–ª–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω—ã–π retrieval –Ω–∞ RU+EN –∏ –∫–æ–º–∞–Ω–¥–Ω—ã—Ö —Ç–µ–∫—Å—Ç–∞—Ö

### 1.3 –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ code blocks –≤ Markdown

**–§–∞–π–ª:** `document_loaders.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –ù–ï —É–¥–∞–ª—è—Ç—å code blocks (````...````) –ø—Ä–∏ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
- –ò–∑–≤–ª–µ–∫–∞—Ç—å –∫–æ–¥ –∏–∑ –±–ª–æ–∫–æ–≤ –∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ `chunk_kind="code"`
- –î–æ–±–∞–≤–ª—è—Ç—å –ø—Ä–µ—Ñ–∏–∫—Å `CODE:` –∫ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É code blocks –¥–ª—è –ª—É—á—à–µ–π –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** –ö–æ–º–∞–Ω–¥—ã –∏–∑ code blocks –±—É–¥—É—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –ø—Ä–∏ –ø–æ–∏—Å–∫–µ

## –≠—Ç–∞–ø 2: –£–ª—É—á—à–µ–Ω–∏–µ —á–∞–Ω–∫–∏–Ω–≥–∞

### 2.1 –°—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π —á–∞–Ω–∫–∏–Ω–≥

**–§–∞–π–ª:** `document_loaders.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –†–∞–∑–±–∏–≤–∞—Ç—å –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ: –∑–∞–≥–æ–ª–æ–≤–∫–∏ ‚Üí –∞–±–∑–∞—Ü—ã ‚Üí —Å–ø–∏—Å–∫–∏ ‚Üí code blocks
- –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ —à–∞–≥–∏ "1. ... 2. ..." –ø–æ–ø–∞–¥–∞—é—Ç –≤ –æ–¥–∏–Ω/—Å–æ—Å–µ–¥–Ω–∏–π chunk
- –£–ª—É—á—à–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ: `section_path`, `chunk_no`, `total_chunks_in_section`

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** –ë–æ–ª–µ–µ —Å–≤—è–∑–Ω—ã–µ —á–∞–Ω–∫–∏, –ª—É—á—à–µ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∫–æ–º–∞–Ω–¥

## –≠—Ç–∞–ø 3: –£–ª—É—á—à–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞

### 3.1 BM25 –≤–º–µ—Å—Ç–æ –ø—Ä–æ—Å—Ç–æ–≥–æ keyword search

**–§–∞–π–ª:** `rag_system.py`

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** `pip install rank-bm25`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –ó–∞–º–µ–Ω–∏—Ç—å `_simple_search()` –Ω–∞ `_bm25_search()`
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `BM25Okapi` –¥–ª—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
- –¢–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è: –∞–Ω–≥–ª - whitespace+lower, —Ä—É—Å - –±—É–∫–≤—ã/—Ü–∏—Ñ—Ä—ã

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –ª—É—á—à–∏–π keyword search

### 3.2 –£–ª—É—á—à–µ–Ω–∏–µ reranker –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ

**–§–∞–π–ª:** `rag_system.py`, `config.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é `RAG_RERANK_MODEL_RU` / `RAG_RERANK_MODEL_MULTI`
- –ê–≤—Ç–æ–ø–æ–¥–±–æ—Ä –º–æ–¥–µ–ª–∏ –ø–æ —è–∑—ã–∫—É –∑–∞–ø—Ä–æ—Å–∞ (`detect_language`)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º—É–ª—å—Ç–∏—è–∑—ã—á–Ω—ã–µ –º–æ–¥–µ–ª–∏ –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** –õ—É—á—à–∞—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –¥–ª—è —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

## –≠—Ç–∞–ø 4: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞

### 4.1 –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å source_id —Ç–µ–≥–∞–º–∏

**–§–∞–π–ª:** `backend_service/api/routes/rag.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –ü—Ä–∏ —Å–±–æ—Ä–∫–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –æ–±–æ—Ä–∞—á–∏–≤–∞—Ç—å –∫–∞–∂–¥—ã–π chunk –≤ `<source_id=kb{kb_id}_chunk{chunk_id}>`
- –î–æ–±–∞–≤–∏—Ç—å title, source_path, section_path –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
- –¢—Ä–µ–±–æ–≤–∞—Ç—å –æ—Ç LLM —Ü–∏—Ç–∏—Ä–æ–≤–∞—Ç—å —Ö–æ—Ç—è –±—ã 1 –∏—Å—Ç–æ—á–Ω–∏–∫

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** –ë–æ–ª–µ–µ —Ç–æ—á–Ω—ã–µ —Ü–∏—Ç–∞—Ç—ã –∏ —Å—Å—ã–ª–∫–∏ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∏

## –≠—Ç–∞–ø 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 5.1 –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

```bash
# –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –±–∞–∑—É –∑–Ω–∞–Ω–∏–π
python -c "from rag_system import rag_system; kb = rag_system.add_knowledge_base('Test KB')"

# –ó–∞–≥—Ä—É–∑–∏—Ç—å Sync&Build.md –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π (—á–µ—Ä–µ–∑ –±–æ—Ç–∞ –∏–ª–∏ –Ω–∞–ø—Ä—è–º—É—é)

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
python tests/test_rag_quality.py --kb-name "Test KB"
```

## –ü–æ—Ä—è–¥–æ–∫ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

1. **–ù–µ–¥–µ–ª—è 1:** –≠—Ç–∞–ø 1 (–∫—Ä–∏—Ç–∏—á–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è) - —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞, cosine similarity, code blocks
2. **–ù–µ–¥–µ–ª—è 2:** –≠—Ç–∞–ø 2 (—á–∞–Ω–∫–∏–Ω–≥) + –≠—Ç–∞–ø 3.1 (BM25)
3. **–ù–µ–¥–µ–ª—è 3:** –≠—Ç–∞–ø 3.2 (reranker) + –≠—Ç–∞–ø 4 (—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞)
4. **–ù–µ–¥–µ–ª—è 4:** –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–æ—Ä–∞–±–æ—Ç–∫–∞

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–î–æ–±–∞–≤–∏—Ç—å –≤ `config.py` –∏ `env.template`:

```python
# RAG Index Configuration
RAG_INDEX_PER_KB = True  # –†–∞–∑–¥–µ–ª—è—Ç—å –∏–Ω–¥–µ–∫—Å –ø–æ –±–∞–∑–∞–º –∑–Ω–∞–Ω–∏–π
RAG_SIMILARITY = "cosine"  # cosine –∏–ª–∏ l2

# RAG Reranker Configuration
RAG_RERANK_MODEL_EN = "cross-encoder/ms-marco-MiniLM-L-6-v2"  # –î–ª—è –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ
RAG_RERANK_MODEL_MULTI = "BAAI/bge-reranker-base"  # –ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω—ã–π (RU+EN)

# RAG Search Configuration
RAG_USE_BM25 = True  # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å BM25 –≤–º–µ—Å—Ç–æ –ø—Ä–æ—Å—Ç–æ–≥–æ keyword search
RAG_FINAL_TOPK = 12  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞–Ω–∫–æ–≤ –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
```

