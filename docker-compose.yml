services:
  bot:
    build: .
    container_name: telegram_rag_bot
    restart: unless-stopped
    env_file:
      - .env
    depends_on:
      - db
      - redis
      - n8n
    volumes:
      # Внешний каталог с пользовательскими данными / настройками
      - ./data:/app/data
      # Монтирование для SQLite базы данных (если используется)
      - ./data/db:/app/data/db
    environment:
      # Путь к данным бота (для кэширования моделей)
      - BOT_DATA_DIR=/app/data
      # Кэш для HuggingFace моделей (HF_HOME используется вместо устаревшего TRANSFORMERS_CACHE)
      - HF_HOME=/app/data/cache/huggingface
      # Настройки интеграции с n8n (по умолчанию - локальный сервис docker-compose)
      - N8N_BASE_URL=${N8N_BASE_URL:-http://n8n:5678}
      - N8N_DEFAULT_WEBHOOK=${N8N_DEFAULT_WEBHOOK:-}
      - N8N_PUBLIC_URL=${N8N_PUBLIC_URL:-http://localhost:5678}
    # Раскомментируйте для использования GPU (требует nvidia-docker или Docker с поддержкой GPU)
    # Для работы GPU необходимо:
    # 1. Установить nvidia-container-toolkit (https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html)
    # 2. Раскомментировать секцию deploy ниже
    # 3. Установить RAG_DEVICE=cuda в .env файле
    deploy:
       resources:
         reservations:
           devices:
             - driver: nvidia
               count: all
               capabilities: [gpu]

  backend:
    build: .
    container_name: telegram_rag_backend
    restart: unless-stopped
    env_file:
      - .env
    depends_on:
      - db
      - redis
    command: ["uvicorn", "backend.app:app", "--host", "0.0.0.0", "--port", "8000"]
    volumes:
      - ./data:/app/data
      - ./data/db:/app/data/db
    environment:
      - BOT_DATA_DIR=/app/data
      - HF_HOME=/app/data/cache/huggingface
    deploy:
       resources:
         reservations:
           devices:
             - driver: nvidia
               count: all
               capabilities: [gpu]

  db:
    image: mysql:8.0
    container_name: telegram_rag_db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-telegram_chatbot}
      MYSQL_USER: ${MYSQL_USER:-telegram}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-telegram}
    ports:
      - "3306:3306"
    volumes:
      - db_data:/var/lib/mysql
    # Убеждаемся, что данные сохраняются
    command: --default-authentication-plugin=mysql_native_password

  redis:
    image: redis:7
    container_name: telegram_rag_redis
    restart: unless-stopped
    command: ["redis-server", "--appendonly", "yes"]
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  n8n:
    image: n8nio/n8n:1.68.1
    container_name: telegram_rag_n8n
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - N8N_HOST=0.0.0.0
      - WEBHOOK_URL=${N8N_PUBLIC_URL:-http://localhost:5678/}
      - GENERIC_TIMEZONE=UTC
      - TZ=UTC
    ports:
      - "5678:5678"
    volumes:
      - ./data/n8n:/home/node/.n8n

volumes:
  db_data:
  redis_data:


